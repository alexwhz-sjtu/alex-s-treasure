<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¾å¤‡æ•°æ®ç®¡ç†å¹³å°</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        .result-box {
            min-height: 200px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: Consolas, Monaco, monospace;
            font-size: 14px;
        }
        .header {
            background: linear-gradient(135deg, #005BAC 0%, #E31937 100%);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
        }
        .btn-action {
            margin: 5px;
            padding: 10px 20px;
        }
        .danger-zone {
            border-top: 2px dashed #dc3545;
            padding-top: 20px;
            margin-top: 30px;
        }
        #downloadExcelBtn {
            margin: 10px 0;
        }
        #downloadArea {
            display: none; /* é»˜è®¤éšè— */
            text-align: right;
        }
        .insert-section input.form-control {
            font-size: 12px;
            padding: 4px 8px;
        }
        .insert-section label {
            font-size: 12px;
            font-weight: normal;
        }
        /* æ–°å¢ç§»åŠ¨ç«¯æç¤ºæ ·å¼ */
        .mobile-download-tip {
            display: none;
            background-color: #f8f9fa;
            border-left: 4px solid #0d6efd;
            padding: 10px 15px;
            margin-top: 10px;
            border-radius: 4px;
        }
        /* ç§»åŠ¨è®¾å¤‡é€‚é… */
        @media (max-width: 768px) {
            .btn-action {
                width: 100%;
                margin: 5px 0;
            }
            .header {
                padding: 20px 0;
            }
            .header h1 {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>

<!-- å¤´éƒ¨ -->
<div class="header text-center">
    <div class="container">
        <h1>ğŸ“¡ ä¸œèˆªæ— åŠ¨åŠ›è½¦è®¾å¤‡ç®¡ç†å¹³å°</h1>
    </div>
</div>

<div class="container">

    <!-- æŸ¥è¯¢åŒºåŸŸ -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5>ğŸ” æŸ¥è¯¢è®¾å¤‡æœ€è¿‘è®°å½•</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-5">
                    <label class="form-label">ä¸»è®¾å¤‡ MAC åœ°å€</label>
                    <input type="text" id="macInput" class="form-control" placeholder="å¦‚ï¼šAB2311000002" value="AB2311000002">
                </div>
                <div class="col-md-3">
                    <label class="form-label">è¿”å›æ¡æ•°</label>
                    <input type="number" id="numInput" class="form-control" value="5" min="1" max="100">
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button onclick="queryData()" class="btn btn-success btn-action">
                        <span id="queryBtnText">æŸ¥è¯¢è®°å½•</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ é™¤åŒºåŸŸ -->
    <div class="card mb-4">
        <div class="card-header bg-warning text-dark">
            <h5>ğŸ—‘ï¸ åˆ é™¤æŒ‡å®šè®¾å¤‡è®°å½•</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-8">
                    <label class="form-label">è¦åˆ é™¤çš„ä¸»è®¾å¤‡ MAC</label>
                    <input type="text" id="deleteMacInput" class="form-control" placeholder="å¦‚ï¼šAB2311000002" value="AB2311000002">
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button onclick="deleteByMac()" class="btn btn-danger btn-action">åˆ é™¤è¯¥è®¾å¤‡æ‰€æœ‰è®°å½•</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å±é™©åŒºåŸŸ -->
    <div class="card mb-4 danger-zone">
        <div class="card-header bg-danger text-white">
            <h5>âš ï¸ å±é™©æ“ä½œåŒº</h5>
        </div>
        <div class="card-body">
            <p class="text-danger"><strong>æ³¨æ„ï¼š</strong>æ­¤æ“ä½œå°†æ¸…ç©ºæ•°æ®åº“ä¸­æ‰€æœ‰è®°å½•ï¼Œä¸å¯æ¢å¤ï¼</p>
            <button onclick="deleteAll()" class="btn btn-outline-danger btn-action">ğŸš¨ æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
        </div>
    </div>

    <!-- âœ… æ–°å¢ï¼šæ’å…¥æ•°æ®åŒºåŸŸ -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5>ğŸ“¥ æ‰‹åŠ¨æ’å…¥æ–°è®°å½•</h5>
        </div>
        <div class="card-body insert-section">
            <div class="row g-2">
                <div class="col-md-3">
                    <label>v</label>
                    <input type="number" id="insertV" class="form-control form-control-sm" value="1" required>
                </div>
                <div class="col-md-3">
                    <label>ä¸»è®¾å¤‡ MAC</label>
                    <input type="text" id="insertMainMac" class="form-control form-control-sm" value="AB231100000F" required>
                </div>
                <div class="col-md-3">
                    <label>QCCID</label>
                    <input type="text" id="insertQccid" class="form-control form-control-sm" value="898604D2192220256819" required>
                </div>
                <div class="col-md-3">
                    <label>ç”µé‡</label>
                    <input type="number" id="insertBattery" class="form-control form-control-sm" value="88" required>
                </div>
                <div class="col-md-3">
                    <label>çº¬åº¦</label>
                    <input type="number" id="insertLat" class="form-control form-control-sm" value="0" step="0.000001" required>
                </div>
                <div class="col-md-3">
                    <label>ç»åº¦</label>
                    <input type="number" id="insertLon" class="form-control form-control-sm" value="0" step="0.000001" required>
                </div>
                <div class="col-md-3">
                    <label>æ—¶é—´ B</label>
                    <input type="text" id="insertTimeB" class="form-control form-control-sm" value="68BAFA40" required>
                </div>
                <div class="col-md-3">
                    <label>æ‰«æç±»å‹</label>
                    <input type="number" id="insertScanType" class="form-control form-control-sm" value="4" required>
                </div>
                <div class="col-md-3">
                    <label>æ‰«ææ—¶é—´</label>
                    <input type="text" id="insertTime" class="form-control form-control-sm" value="68BAFA3D" required>
                </div>
                <div class="col-md-3">
                    <label>Beacon MAC</label>
                    <input type="text" id="insertBeaconMac" class="form-control form-control-sm" value="84C2E4000033" required>
                </div>
                <div class="col-md-3">
                    <label>RSSI</label>
                    <input type="number" id="insertRssi" class="form-control form-control-sm" value="-65" required>
                </div>
                <div class="col-md-3">
                    <label>å¹¿æ’­æ•°æ®</label>
                    <input type="text" id="insertAdvData" class="form-control form-control-sm" value="FFFF0000000000000000000000000000000000000000000000000000000000" required>
                </div>
                <div class="col-12 mt-2">
                    <button onclick="insertData()" class="btn btn-primary btn-sm">ğŸš€ æ’å…¥æ•°æ®</button>
                    <span id="insertResult" class="ms-2"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- ç»“æœå±•ç¤ºåŒº -->
    <h4>ğŸ“Š æ“ä½œç»“æœ</h4>
    <!-- ä¸‹è½½æŒ‰é’®åŒºåŸŸï¼ˆé»˜è®¤éšè—ï¼‰ -->
    <div id="downloadArea">
        <!-- æ–°å¢ç§»åŠ¨ç«¯ä¸‹è½½æç¤º -->
        <div id="mobileDownloadTip" class="mobile-download-tip">
            <strong>ğŸ“± ç§»åŠ¨ç«¯ä¸‹è½½æç¤ºï¼š</strong>
            <p>åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šï¼ŒExcelæ–‡ä»¶å¯èƒ½ä¼šåœ¨ä¸‹è½½åè‡ªåŠ¨æ‰“å¼€ã€‚å¦‚éœ€ä¿å­˜ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’çš„"..."æˆ–"æ›´å¤š"é€‰é¡¹ï¼Œç„¶åé€‰æ‹©"ä¸‹è½½"æˆ–"ä¿å­˜"ã€‚</p>
        </div>
    </div>
    <!-- ç»“æœæ¡† -->
    <div class="result-box" id="resultBox">
        ç­‰å¾…æ“ä½œ...
    </div>

</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const resultBox = document.getElementById('resultBox');
    const queryBtnText = document.getElementById('queryBtnText');
    const downloadArea = document.getElementById('downloadArea');
    const insertResult = document.getElementById('insertResult');
    const mobileDownloadTip = document.getElementById('mobileDownloadTip');
    let lastQueryData = null; // ä¿å­˜æœ€åä¸€æ¬¡æŸ¥è¯¢ç»“æœï¼Œç”¨äºå¯¼å‡º

    // è®¾ç½®åŸºç¡€URLï¼ˆæ ¹æ®ä½ çš„åç«¯åœ°å€è°ƒæ•´ï¼‰
    const API_BASE = 'http://101.133.172.181:8049';

    // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
    function isMobileDevice() {
        return (typeof window.orientation !== "undefined") || (navigator.userAgent.indexOf('IEMobile') !== -1);
    }

    // åˆå§‹åŒ–ï¼šä¸ºè¾“å…¥æ¡†ç»‘å®šå›è½¦äº‹ä»¶
    document.addEventListener('DOMContentLoaded', function() {
        const macInput = document.getElementById('macInput');
        const numInput = document.getElementById('numInput');

        [macInput, numInput].forEach(input => {
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    queryData();
                }
            });
        });

        // å¦‚æœæ˜¯ç§»åŠ¨è®¾å¤‡ï¼Œæ˜¾ç¤ºä¸‹è½½æç¤º
        if (isMobileDevice()) {
            mobileDownloadTip.style.display = 'block';
        }
    });

    // æŸ¥è¯¢æ•°æ®
    async function queryData() {
        const mac = document.getElementById('macInput').value.trim();
        const num = document.getElementById('numInput').value.trim();

        if (!mac) {
            alert('è¯·è¾“å…¥ MAC åœ°å€');
            return;
        }

        try {
            queryBtnText.textContent = 'æŸ¥è¯¢ä¸­...';
            resultBox.textContent = 'æ­£åœ¨åŠ è½½æ•°æ®...';
            resultBox.className = 'result-box text-primary';

            // éšè—æ—§çš„ä¸‹è½½æŒ‰é’®
            downloadArea.style.display = 'none';
            downloadArea.innerHTML = '';

            const res = await axios.get(`${API_BASE}/by_mac/${mac}/${num}`);

            if (res.data && Array.isArray(res.data) && res.data.length > 0) {
                resultBox.textContent = JSON.stringify(res.data, null, 2);
                resultBox.className = 'result-box text-success';
                lastQueryData = res.data; // ä¿å­˜åŸå§‹æ•°æ®

                // åˆ›å»º"ä¸‹è½½ä¸º Excel"æŒ‰é’®å¹¶æ’å…¥åˆ° downloadArea
                const downloadBtn = document.createElement('button');
                downloadBtn.id = 'downloadExcelBtn';
                downloadBtn.className = 'btn btn-outline-primary';
                downloadBtn.innerHTML = 'ğŸ“¥ ä¸‹è½½ä¸º Excel';
                downloadBtn.onclick = exportToExcel;

                downloadArea.appendChild(downloadBtn);
                
                // å¦‚æœæ˜¯ç§»åŠ¨è®¾å¤‡ï¼Œé‡æ–°æ˜¾ç¤ºæç¤º
                if (isMobileDevice()) {
                    mobileDownloadTip.style.display = 'block';
                    downloadArea.appendChild(mobileDownloadTip);
                }
                
                downloadArea.style.display = 'block'; // æ˜¾ç¤ºåŒºåŸŸ

            } else {
                resultBox.textContent = `âœ… æŸ¥è¯¢æˆåŠŸï¼Œä½†æœªæ‰¾åˆ° MAC ä¸º ${mac} çš„è®°å½•ã€‚`;
                resultBox.className = 'result-box text-info';
            }
        } catch (err) {
            resultBox.textContent = `âŒ æŸ¥è¯¢å¤±è´¥ï¼š${err.message}\n\nè¯·æ£€æŸ¥ï¼š\n1. åç«¯æ˜¯å¦è¿è¡Œ\n2. ç½‘ç»œæ˜¯å¦é€šç•…\n3. MACæ ¼å¼æ˜¯å¦æ­£ç¡®`;
            resultBox.className = 'result-box text-danger';
        } finally {
            queryBtnText.textContent = 'æŸ¥è¯¢è®°å½•';
        }
    }

    // å¯¼å‡ºä¸º Excel
    function exportToExcel() {
        if (!lastQueryData || !Array.isArray(lastQueryData) || lastQueryData.length === 0) {
            alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');
            return;
        }

        try {
            // ä½¿ç”¨ SheetJS åˆ›å»ºå·¥ä½œç°¿
            const worksheet = XLSX.utils.json_to_sheet(lastQueryData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "è®¾å¤‡æ•°æ®");

            // ç”Ÿæˆæ–‡ä»¶å¹¶ä¸‹è½½
            const fileName = `è®¾å¤‡æ•°æ®_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(workbook, fileName);
            
            // ç§»åŠ¨è®¾å¤‡ä¸Šé¢å¤–æç¤º
            if (isMobileDevice()) {
                setTimeout(() => {
                    alert(`æ–‡ä»¶ "${fileName}" å·²å¼€å§‹ä¸‹è½½ã€‚è¯·åœ¨æµè§ˆå™¨ä¸‹è½½ç®¡ç†ä¸­æŸ¥çœ‹ã€‚`);
                }, 1000);
            }
        } catch (error) {
            console.error('å¯¼å‡ºExcelå¤±è´¥:', error);
            alert('å¯¼å‡ºExcelæ–‡ä»¶æ—¶å‡ºé”™: ' + error.message);
        }
    }

    // åˆ é™¤æŒ‡å®š MAC
    async function deleteByMac() {
        const mac = document.getElementById('deleteMacInput').value.trim();
        if (!mac) {
            alert('è¯·è¾“å…¥è¦åˆ é™¤çš„ MAC åœ°å€');
            return;
        }

        if (!confirm(`ç¡®å®šè¦åˆ é™¤ MAC åœ°å€ä¸º ${mac} çš„æ‰€æœ‰è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
            return;
        }

        try {
            resultBox.textContent = 'æ­£åœ¨åˆ é™¤...';
            resultBox.className = 'result-box text-primary';

            const res = await axios.delete(`${API_BASE}/delete/mac/${mac}`);
            resultBox.textContent = `âœ… ${res.data}`;
            resultBox.className = 'result-box text-success';

            // åˆ é™¤åéšè—ä¸‹è½½æŒ‰é’®
            downloadArea.style.display = 'none';
            downloadArea.innerHTML = '';
        } catch (err) {
            resultBox.textContent = `âŒ åˆ é™¤å¤±è´¥ï¼š${err.message}`;
            resultBox.className = 'result-box text-danger';
        }
    }

    // åˆ é™¤æ‰€æœ‰æ•°æ®
    async function deleteAll() {
        if (!confirm('âš ï¸ è­¦å‘Šï¼ä½ å³å°†æ¸…ç©ºæ•°æ®åº“ä¸­æ‰€æœ‰è®°å½•ï¼\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ')) {
            return;
        }

        try {
            resultBox.textContent = 'æ­£åœ¨æ¸…ç©ºæ‰€æœ‰æ•°æ®...';
            resultBox.className = 'result-box text-primary';

            const res = await axios.delete(`${API_BASE}/delete/all`);
            resultBox.textContent = `âœ… ${res.data}`;
            resultBox.className = 'result-box text-success';

            // æ¸…ç©ºåéšè—ä¸‹è½½æŒ‰é’®
            downloadArea.style.display = 'none';
            downloadArea.innerHTML = '';
        } catch (err) {
            resultBox.textContent = `âŒ æ¸…ç©ºå¤±è´¥ï¼š${err.message}`;
            resultBox.className = 'result-box text-danger';
        }
    }

    // âœ… æ–°å¢ï¼šæ’å…¥æ•°æ®å‡½æ•°
    async function insertData() {
        const data = {
            v: parseInt(document.getElementById('insertV').value),
            mac: document.getElementById('insertMainMac').value.trim(), // æ”¹ä¸ºmac
            qccid: document.getElementById('insertQccid').value.trim(),
            battery: parseInt(document.getElementById('insertBattery').value),
            lat: parseFloat(document.getElementById('insertLat').value),
            lon: parseFloat(document.getElementById('insertLon').value),
            time_b: document.getElementById('insertTimeB').value.trim(), // æ”¹ä¸ºtime_b
            scan_type: parseInt(document.getElementById('insertScanType').value), // æ”¹ä¸ºscan_type
            time: document.getElementById('insertTime').value.trim(),
            beacon_mac: document.getElementById('insertBeaconMac').value.trim(), // æ”¹ä¸ºbeacon_mac
            rssi: parseInt(document.getElementById('insertRssi').value),
            adv_data: document.getElementById('insertAdvData').value.trim() // æ”¹ä¸ºadv_data
        };

        // ç®€å•æ ¡éªŒ
        if (!data.mac || !data.qccid || !data.time_b || !data.beacon_mac) {
            insertResult.className = 'text-danger';
            insertResult.textContent = 'âŒ è¯·å¡«å†™å¿…è¦å­—æ®µ';
            return;
        }

        insertResult.className = 'text-primary';
        insertResult.textContent = 'æ’å…¥ä¸­...';

        try {
            const res = await axios.post(`${API_BASE}/insert`, data, {
                headers: { 'Content-Type': 'application/json' }
            });
            insertResult.className = 'text-success';
            insertResult.textContent = 'âœ… ' + res.data;
        } catch (err) {
            insertResult.className = 'text-danger';
            let errorMsg = 'æœªçŸ¥é”™è¯¯';
            if (err.response && err.response.data) {
                // å¦‚æœ data æ˜¯å¯¹è±¡ï¼Œè½¬æˆ JSON å­—ç¬¦ä¸²
                errorMsg = typeof err.response.data === 'object'
                    ? JSON.stringify(err.response.data, null, 2)
                    : err.response.data;
            } else if (err.message) {
                errorMsg = err.message;
            }
            insertResult.textContent = 'âŒ ' + errorMsg;
        }
    }
</script>

</body>
</html>