<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>设备数据管理平台</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        .result-box {
            min-height: 200px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: Consolas, Monaco, monospace;
            font-size: 14px;
        }
        .header {
            background: linear-gradient(135deg, #005BAC 0%, #E31937 100%);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
        }
        .btn-action {
            margin: 5px;
            padding: 10px 20px;
        }
        .danger-zone {
            border-top: 2px dashed #dc3545;
            padding-top: 20px;
            margin-top: 30px;
        }
        #downloadExcelBtn {
            margin: 10px 0;
        }
        #downloadArea {
            display: none; /* 默认隐藏 */
            text-align: right;
        }
        .insert-section input.form-control {
            font-size: 12px;
            padding: 4px 8px;
        }
        .insert-section label {
            font-size: 12px;
            font-weight: normal;
        }
        /* 新增移动端提示样式 */
        .mobile-download-tip {
            display: none;
            background-color: #f8f9fa;
            border-left: 4px solid #0d6efd;
            padding: 10px 15px;
            margin-top: 10px;
            border-radius: 4px;
        }
        /* 移动设备适配 */
        @media (max-width: 768px) {
            .btn-action {
                width: 100%;
                margin: 5px 0;
            }
            .header {
                padding: 20px 0;
            }
            .header h1 {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>

<!-- 头部 -->
<div class="header text-center">
    <div class="container">
        <h1>📡 东航无动力车设备管理平台</h1>
    </div>
</div>

<div class="container">

    <!-- 查询区域 -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5>🔍 查询设备最近记录</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-5">
                    <label class="form-label">主设备 MAC 地址</label>
                    <input type="text" id="macInput" class="form-control" placeholder="如：AB2311000002" value="AB2311000002">
                </div>
                <div class="col-md-3">
                    <label class="form-label">返回条数</label>
                    <input type="number" id="numInput" class="form-control" value="5" min="1" max="100">
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button onclick="queryData()" class="btn btn-success btn-action">
                        <span id="queryBtnText">查询记录</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 删除区域 -->
    <div class="card mb-4">
        <div class="card-header bg-warning text-dark">
            <h5>🗑️ 删除指定设备记录</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-8">
                    <label class="form-label">要删除的主设备 MAC</label>
                    <input type="text" id="deleteMacInput" class="form-control" placeholder="如：AB2311000002" value="AB2311000002">
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button onclick="deleteByMac()" class="btn btn-danger btn-action">删除该设备所有记录</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 危险区域 -->
    <div class="card mb-4 danger-zone">
        <div class="card-header bg-danger text-white">
            <h5>⚠️ 危险操作区</h5>
        </div>
        <div class="card-body">
            <p class="text-danger"><strong>注意：</strong>此操作将清空数据库中所有记录，不可恢复！</p>
            <button onclick="deleteAll()" class="btn btn-outline-danger btn-action">🚨 清空所有数据</button>
        </div>
    </div>

    <!-- ✅ 新增：插入数据区域 -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5>📥 手动插入新记录</h5>
        </div>
        <div class="card-body insert-section">
            <div class="row g-2">
                <div class="col-md-3">
                    <label>v</label>
                    <input type="number" id="insertV" class="form-control form-control-sm" value="1" required>
                </div>
                <div class="col-md-3">
                    <label>主设备 MAC</label>
                    <input type="text" id="insertMainMac" class="form-control form-control-sm" value="AB231100000F" required>
                </div>
                <div class="col-md-3">
                    <label>QCCID</label>
                    <input type="text" id="insertQccid" class="form-control form-control-sm" value="898604D2192220256819" required>
                </div>
                <div class="col-md-3">
                    <label>电量</label>
                    <input type="number" id="insertBattery" class="form-control form-control-sm" value="88" required>
                </div>
                <div class="col-md-3">
                    <label>纬度</label>
                    <input type="number" id="insertLat" class="form-control form-control-sm" value="0" step="0.000001" required>
                </div>
                <div class="col-md-3">
                    <label>经度</label>
                    <input type="number" id="insertLon" class="form-control form-control-sm" value="0" step="0.000001" required>
                </div>
                <div class="col-md-3">
                    <label>时间 B</label>
                    <input type="text" id="insertTimeB" class="form-control form-control-sm" value="68BAFA40" required>
                </div>
                <div class="col-md-3">
                    <label>扫描类型</label>
                    <input type="number" id="insertScanType" class="form-control form-control-sm" value="4" required>
                </div>
                <div class="col-md-3">
                    <label>扫描时间</label>
                    <input type="text" id="insertTime" class="form-control form-control-sm" value="68BAFA3D" required>
                </div>
                <div class="col-md-3">
                    <label>Beacon MAC</label>
                    <input type="text" id="insertBeaconMac" class="form-control form-control-sm" value="84C2E4000033" required>
                </div>
                <div class="col-md-3">
                    <label>RSSI</label>
                    <input type="number" id="insertRssi" class="form-control form-control-sm" value="-65" required>
                </div>
                <div class="col-md-3">
                    <label>广播数据</label>
                    <input type="text" id="insertAdvData" class="form-control form-control-sm" value="FFFF0000000000000000000000000000000000000000000000000000000000" required>
                </div>
                <div class="col-12 mt-2">
                    <button onclick="insertData()" class="btn btn-primary btn-sm">🚀 插入数据</button>
                    <span id="insertResult" class="ms-2"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- 结果展示区 -->
    <h4>📊 操作结果</h4>
    <!-- 下载按钮区域（默认隐藏） -->
    <div id="downloadArea">
        <!-- 新增移动端下载提示 -->
        <div id="mobileDownloadTip" class="mobile-download-tip">
            <strong>📱 移动端下载提示：</strong>
            <p>在移动设备上，Excel文件可能会在下载后自动打开。如需保存，请点击右上角的"..."或"更多"选项，然后选择"下载"或"保存"。</p>
        </div>
    </div>
    <!-- 结果框 -->
    <div class="result-box" id="resultBox">
        等待操作...
    </div>

</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const resultBox = document.getElementById('resultBox');
    const queryBtnText = document.getElementById('queryBtnText');
    const downloadArea = document.getElementById('downloadArea');
    const insertResult = document.getElementById('insertResult');
    const mobileDownloadTip = document.getElementById('mobileDownloadTip');
    let lastQueryData = null; // 保存最后一次查询结果，用于导出

    // 设置基础URL（根据你的后端地址调整）
    const API_BASE = 'http://101.133.172.181:8049';

    // 检测是否为移动设备
    function isMobileDevice() {
        return (typeof window.orientation !== "undefined") || (navigator.userAgent.indexOf('IEMobile') !== -1);
    }

    // 初始化：为输入框绑定回车事件
    document.addEventListener('DOMContentLoaded', function() {
        const macInput = document.getElementById('macInput');
        const numInput = document.getElementById('numInput');

        [macInput, numInput].forEach(input => {
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    queryData();
                }
            });
        });

        // 如果是移动设备，显示下载提示
        if (isMobileDevice()) {
            mobileDownloadTip.style.display = 'block';
        }
    });

    // 查询数据
    async function queryData() {
        const mac = document.getElementById('macInput').value.trim();
        const num = document.getElementById('numInput').value.trim();

        if (!mac) {
            alert('请输入 MAC 地址');
            return;
        }

        try {
            queryBtnText.textContent = '查询中...';
            resultBox.textContent = '正在加载数据...';
            resultBox.className = 'result-box text-primary';

            // 隐藏旧的下载按钮
            downloadArea.style.display = 'none';
            downloadArea.innerHTML = '';

            const res = await axios.get(`${API_BASE}/by_mac/${mac}/${num}`);

            if (res.data && Array.isArray(res.data) && res.data.length > 0) {
                resultBox.textContent = JSON.stringify(res.data, null, 2);
                resultBox.className = 'result-box text-success';
                lastQueryData = res.data; // 保存原始数据

                // 创建"下载为 Excel"按钮并插入到 downloadArea
                const downloadBtn = document.createElement('button');
                downloadBtn.id = 'downloadExcelBtn';
                downloadBtn.className = 'btn btn-outline-primary';
                downloadBtn.innerHTML = '📥 下载为 Excel';
                downloadBtn.onclick = exportToExcel;

                downloadArea.appendChild(downloadBtn);
                
                // 如果是移动设备，重新显示提示
                if (isMobileDevice()) {
                    mobileDownloadTip.style.display = 'block';
                    downloadArea.appendChild(mobileDownloadTip);
                }
                
                downloadArea.style.display = 'block'; // 显示区域

            } else {
                resultBox.textContent = `✅ 查询成功，但未找到 MAC 为 ${mac} 的记录。`;
                resultBox.className = 'result-box text-info';
            }
        } catch (err) {
            resultBox.textContent = `❌ 查询失败：${err.message}\n\n请检查：\n1. 后端是否运行\n2. 网络是否通畅\n3. MAC格式是否正确`;
            resultBox.className = 'result-box text-danger';
        } finally {
            queryBtnText.textContent = '查询记录';
        }
    }

    // 导出为 Excel
    function exportToExcel() {
        if (!lastQueryData || !Array.isArray(lastQueryData) || lastQueryData.length === 0) {
            alert('没有可导出的数据');
            return;
        }

        try {
            // 使用 SheetJS 创建工作簿
            const worksheet = XLSX.utils.json_to_sheet(lastQueryData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "设备数据");

            // 生成文件并下载
            const fileName = `设备数据_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(workbook, fileName);
            
            // 移动设备上额外提示
            if (isMobileDevice()) {
                setTimeout(() => {
                    alert(`文件 "${fileName}" 已开始下载。请在浏览器下载管理中查看。`);
                }, 1000);
            }
        } catch (error) {
            console.error('导出Excel失败:', error);
            alert('导出Excel文件时出错: ' + error.message);
        }
    }

    // 删除指定 MAC
    async function deleteByMac() {
        const mac = document.getElementById('deleteMacInput').value.trim();
        if (!mac) {
            alert('请输入要删除的 MAC 地址');
            return;
        }

        if (!confirm(`确定要删除 MAC 地址为 ${mac} 的所有记录吗？此操作不可恢复！`)) {
            return;
        }

        try {
            resultBox.textContent = '正在删除...';
            resultBox.className = 'result-box text-primary';

            const res = await axios.delete(`${API_BASE}/delete/mac/${mac}`);
            resultBox.textContent = `✅ ${res.data}`;
            resultBox.className = 'result-box text-success';

            // 删除后隐藏下载按钮
            downloadArea.style.display = 'none';
            downloadArea.innerHTML = '';
        } catch (err) {
            resultBox.textContent = `❌ 删除失败：${err.message}`;
            resultBox.className = 'result-box text-danger';
        }
    }

    // 删除所有数据
    async function deleteAll() {
        if (!confirm('⚠️ 警告！你即将清空数据库中所有记录！\n\n此操作不可恢复，确定继续吗？')) {
            return;
        }

        try {
            resultBox.textContent = '正在清空所有数据...';
            resultBox.className = 'result-box text-primary';

            const res = await axios.delete(`${API_BASE}/delete/all`);
            resultBox.textContent = `✅ ${res.data}`;
            resultBox.className = 'result-box text-success';

            // 清空后隐藏下载按钮
            downloadArea.style.display = 'none';
            downloadArea.innerHTML = '';
        } catch (err) {
            resultBox.textContent = `❌ 清空失败：${err.message}`;
            resultBox.className = 'result-box text-danger';
        }
    }

    // ✅ 新增：插入数据函数
    async function insertData() {
        const data = {
            v: parseInt(document.getElementById('insertV').value),
            mac: document.getElementById('insertMainMac').value.trim(), // 改为mac
            qccid: document.getElementById('insertQccid').value.trim(),
            battery: parseInt(document.getElementById('insertBattery').value),
            lat: parseFloat(document.getElementById('insertLat').value),
            lon: parseFloat(document.getElementById('insertLon').value),
            time_b: document.getElementById('insertTimeB').value.trim(), // 改为time_b
            scan_type: parseInt(document.getElementById('insertScanType').value), // 改为scan_type
            time: document.getElementById('insertTime').value.trim(),
            beacon_mac: document.getElementById('insertBeaconMac').value.trim(), // 改为beacon_mac
            rssi: parseInt(document.getElementById('insertRssi').value),
            adv_data: document.getElementById('insertAdvData').value.trim() // 改为adv_data
        };

        // 简单校验
        if (!data.mac || !data.qccid || !data.time_b || !data.beacon_mac) {
            insertResult.className = 'text-danger';
            insertResult.textContent = '❌ 请填写必要字段';
            return;
        }

        insertResult.className = 'text-primary';
        insertResult.textContent = '插入中...';

        try {
            const res = await axios.post(`${API_BASE}/insert`, data, {
                headers: { 'Content-Type': 'application/json' }
            });
            insertResult.className = 'text-success';
            insertResult.textContent = '✅ ' + res.data;
        } catch (err) {
            insertResult.className = 'text-danger';
            let errorMsg = '未知错误';
            if (err.response && err.response.data) {
                // 如果 data 是对象，转成 JSON 字符串
                errorMsg = typeof err.response.data === 'object'
                    ? JSON.stringify(err.response.data, null, 2)
                    : err.response.data;
            } else if (err.message) {
                errorMsg = err.message;
            }
            insertResult.textContent = '❌ ' + errorMsg;
        }
    }
</script>

</body>
</html>